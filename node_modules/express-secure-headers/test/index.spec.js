const request = require('supertest');
const express = require('express');
const expressSecureHeaders = require('../index');

// init express app
const app = express();

// secure headers
app.use(expressSecureHeaders);

app.get('/', function(req, res) {
    res.status(200).send('ok');
});
  
describe('express-secure-header', () => {

  test('Cross-Origin Resource Sharing (CORS)',function(done){

    request(app).get('/').then((response) => {

      expect(response.header['access-control-allow-origin']).toBe('*');

      expect(response.header['access-control-allow-headers']).toBe('*');

      expect(response.header['access-control-allow-methods']).toBe('GET,POST,PUT,DELETE');

      done();

    });

  });

  test('X-Powered-By',function(done){

      request(app).get('/').then((response) => {

        expect(response.header['x-powered-by']).toBeUndefined();

        done();

      });

    });
  

  test('X-Permitted-Cross-Domain-Policies',function(done){

      request(app).get('/').then((response) => {

        expect(response.header['x-permitted-cross-domain-policies']).toBe('none');

        done();

      });

  });
   
  test('Content-Security-Policy',function(done){

    request(app).get('/').then((response) => {

       expect(response.header['x-content-security-policy']).toBe("default-src 'self'; script-src 'self'; object-src 'self'; style-src 'self'; img-src 'self' data:; media-src 'self'; frame-src 'self'; font-src 'self'; connect-src 'self'");

      done();

    });

  });


  test('DNS Prefetch Control',function(done){

    request(app).get('/').then((response) => {

      expect(response.header['x-dns-prefetch-control']).toBe('off');

      done();

    });

  });


  test('Click Jacking Attack',function(done){

    request(app).get('/').then((response) => {

      expect(response.header['x-frame-options']).toBe('deny');

      done();

    });

  });


  test('Strict-Transport-Security',function(done){

    request(app).get('/').then((response) => {

      expect(response.header['strict-transport-security']).toBe('max-age=5184000,preload');

      done();

    });

  });


  test('Mime Sniffing Attack',function(done){

    request(app).get('/').then((response) => {

      expect(response.header['x-content-type-options']).toBe('nosniff');

      done();

    });

  });


  test('Cross site scripting (XSS)',function(done){

    request(app).get('/').then((response) => {

      expect(response.header['x-xss-protection']).toBe('1; mode=block');

      done();

    });

  });

  test('Server Sniffing Information',function(done){

    request(app).get('/').then((response) => {

      expect(response.header['server']).toBeUndefined();

      done();

    });

  });


});